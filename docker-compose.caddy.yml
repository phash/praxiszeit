# Caddy-Erweiterung für PraxisZeit
# ─────────────────────────────────────────────────────────────────────────────
# Ersetzt nginx-SSL (docker-compose.ssl.yml) durch Caddy mit automatischem
# HTTPS via Let's Encrypt. Kein manuelles Zertifikatsmanagement erforderlich.
#
# Voraussetzungen:
#   - SERVER_DOMAIN in .env gesetzt (z. B. SERVER_DOMAIN=praxis.example.com)
#   - CORS_ORIGINS in .env auf https://SERVER_DOMAIN gesetzt
#   - Port 80 + 443 (TCP + UDP) auf dem Server geöffnet
#   - DNS: SERVER_DOMAIN zeigt auf die öffentliche IP des Servers
#
# Nutzung:
#   docker compose -f docker-compose.yml -f docker-compose.caddy.yml up -d
#
# Updates:
#   docker compose -f docker-compose.yml -f docker-compose.caddy.yml up -d --build
#
# Hinweis: Erfordert Docker Compose >= v2.20 (wegen !reset-Tag)
# ─────────────────────────────────────────────────────────────────────────────

services:
  # Frontend-Port nicht direkt exponieren – Caddy übernimmt
  frontend:
    ports: !reset []

  # Grafana ROOT_URL auf HTTPS aktualisieren
  grafana:
    environment:
      GF_SERVER_ROOT_URL: https://${SERVER_DOMAIN}/grafana/

  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"          # HTTP (ACME-Challenge + Redirect zu HTTPS)
      - "443:443"        # HTTPS
      - "443:443/udp"    # HTTP/3 (QUIC)
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data          # Zertifikate (persistent!)
      - caddy_config:/config      # Caddy-Laufzeitkonfiguration
    environment:
      SERVER_DOMAIN: ${SERVER_DOMAIN:?SERVER_DOMAIN muss in .env gesetzt sein (z.B. praxis.example.com)}
    depends_on:
      - frontend
    networks:
      - praxiszeit-network

volumes:
  caddy_data:    # Zertifikate hier – Volume NICHT löschen!
  caddy_config:
